# Load necessary libraries
library(tidyverse)

# Define the input file path
input_file <- "/Users/jpmcginnis1/Desktop/Sequencing info and data/RStudio work/organotypic culture paper/against day 0/10-16-24 STL against day 0/Day 0 Combined all Features.csv"

# Define the output directory based on the input file path
output_directory <- dirname(input_file)

# Read the CSV file
data <- read.csv(input_file, check.names = FALSE)

# Clean column names to avoid issues with extra spaces
colnames(data) <- trimws(colnames(data))

# Print the column names to inspect
print("Column names:")
print(colnames(data))

# Get the first two columns (FeatureID and FeatureName)
first_two_columns <- data[, 1:2]

# Get the rest of the columns (excluding the first two)
cluster_data <- data[, -c(1, 2)]

# Identify clusters based on the pattern in the column names
cluster_names <- unique(gsub(" ?day.*$", "", colnames(cluster_data)))

# Manually define day_info if filename structure is inconsistent
day_info <- "day 0"

# Iterate over each cluster and create a separate CSV file for each
for (cluster in cluster_names) {
    # Clean the cluster name
    cleaned_cluster_name <- cluster %>%
        gsub("[,]", "", .) %>%                      # Remove commas
        gsub(" +", " ", .) %>%                      # Collapse extra spaces
        trimws() %>%
        gsub("[/:*?\"<>|]", "_", .)                 # Remove illegal filename characters

    # Dynamically find the relevant column names
    avg_col <- grep(paste0(cleaned_cluster_name, ".*Average"), colnames(data), value = TRUE)
    log2_col <- grep(paste0(cleaned_cluster_name, ".*Log2 Fold Change"), colnames(data), value = TRUE)
    pvalue_col <- grep(paste0(cleaned_cluster_name, ".*P-Value"), colnames(data), value = TRUE)

    # Debugging print for matching columns
    print(paste("Cluster:", cleaned_cluster_name))
    print(paste("  Average column:", avg_col))
    print(paste("  Log2FC column:", log2_col))
    print(paste("  P-Value column:", pvalue_col))

    # Proceed if all three required columns are found
    if (length(avg_col) == 1 && length(log2_col) == 1 && length(pvalue_col) == 1) {
        output_data <- data.frame(
            first_two_columns,
            Average = data[[avg_col]],
            Log2_Fold_Change = data[[log2_col]],
            P_Value = data[[pvalue_col]]
        )

        # Construct safe output file name
        output_file <- file.path(output_directory, paste0(cleaned_cluster_name, "_", day_info, ".csv"))
        print(paste("Saving to:", output_file))

        # Write to CSV
        write.csv(output_data, file = output_file, row.names = FALSE)
        print(paste("✔ Saved:", output_file))
    } else {
        print(paste("⚠ Columns for cluster", cleaned_cluster_name, "not found. Skipping..."))
    }
}

